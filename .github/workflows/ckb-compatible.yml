name: CKB Start Validation

on:
    push:
      branches:
        - develop
    pull_request:
      branches:
        - develop
    workflow_dispatch: 

jobs:
  ckb-start-validation:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-11, macos-12, ubuntu-22.04, ubuntu-22.04-arm64, centos-7, windows-latest]
        include:
          - os: ubuntu-22.04
            arch: x64
          - os: ubuntu-22.04-arm64
            arch: arm64
          - os: macos-11
            arch: x86
          - os: macos-12
            arch: arm64
          - os: centos-7
            arch: x64
          - os: windows-latest
            arch: x64

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up environment variables
        run: |
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            $env:CKB_RELEASE_URL="https://github.com/nervosnetwork/ckb/releases/download/v0.119.0-rc1"
          else
            CKB_RELEASE_URL=https://github.com/nervosnetwork/ckb/releases/download/v0.119.0-rc1
            echo "CKB_RELEASE_URL=$CKB_RELEASE_URL" >> $GITHUB_ENV
          fi

      - name: Download and extract CKB
        run: |
          case "${{ matrix.os }}-${{ matrix.arch }}" in
            "ubuntu-22.04-x64")
              curl -LO $CKB_RELEASE_URL/ckb_v0.119.0-rc1_x86_64-unknown-linux-gnu.tar.gz
              tar -xzf ckb_v0.119.0-rc1_x86_64-unknown-linux-gnu.tar.gz
              ;;
            "ubuntu-22.04-arm64")
              curl -LO $CKB_RELEASE_URL/ckb_v0.119.0-rc1_aarch64-unknown-linux-gnu.tar.gz
              tar -xzf ckb_v0.119.0-rc1_aarch64-unknown-linux-gnu.tar.gz
              ;;
            "macos-11-x86")
              curl -LO $CKB_RELEASE_URL/ckb_v0.119.0-rc1_x86_64-apple-darwin-portable.zip
              unzip ckb_v0.119.0-rc1_x86_64-apple-darwin-portable.zip
              ;;
            "macos-12-arm64")
              curl -LO $CKB_RELEASE_URL/ckb_v0.119.0-rc1_aarch64-apple-darwin-portable.zip
              unzip ckb_v0.119.0-rc1_aarch64-apple-darwin-portable.zip
              ;;
            "centos-7-x64")
              curl -LO $CKB_RELEASE_URL/ckb_v0.119.0-rc1_x86_64-unknown-centos-gnu-portable.tar.gz
              tar -xzf ckb_v0.119.0-rc1_x86_64-unknown-centos-gnu-portable.tar.gz
              ;;
            "windows-latest-x64")
              curl -LO $env:CKB_RELEASE_URL/ckb_v0.119.0-rc1_windows_x86_64.zip
              Expand-Archive -Path ckb_v0.119.0-rc1_windows_x86_64.zip -DestinationPath .
              ;;
            *)
              echo "Unsupported OS or architecture: ${{ matrix.os }} ${{ matrix.arch }}"
              exit 1
              ;;
          esac

      - name: Run CKB node
        run: |
          case "${{ matrix.os }}" in
            "ubuntu-22.04")
              ./ckb/ckb run &
              ;;
            "ubuntu-20.04")
              ./ckb/ckb run &
              ;;
            "centos-7")
              ./ckb/ckb run &
              ;;
            "macos-latest")
              ./ckb/ckb run &
              ;;
            "windows-latest")
              ./ckb/ckb.exe run &
              ;;
            *)
              echo "Unsupported OS: ${{ matrix.os }}"
              exit 1
              ;;
          esac

  
